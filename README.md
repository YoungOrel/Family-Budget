# Домашній бюджет — розширені можливості

## Monobank API

1. У Apps Script відкрийте **Project Settings → Script Properties** та додайте ключ `MONO_TOKEN` із персональним токеном Monobank.
2. За потреби додайте властивість `MONO_ENABLED` (`true`/`false`) і `CACHE_TTL_HOURS` для контролю кешу довідників рахунків.
3. У вкладці "Операції" натисніть **Імпорт з Monobank**, оберіть період (за замовчуванням останні 30 днів) і підтвердьте. 
4. Довідники рахунків і банок кешуються у файлах `monobank_accounts.json` та `monobank_jars.json` у сховищі даних користувача.

Доступні серверні методи:
- `importMonobankStatement({ from, to })`
- `listMonoAccounts()` / `listMonoJars()`
- `getMonobankSettings()` / `updateMonobankSettings(payload)`

## Ручні транзакції

- Кнопка **Нова операція** відкриває форму з валідацією (дата, рахунок, фонд, категорія, ненульова сума).
- Ручні записи зберігаються у `tx_YYYY.json` з полями `itemId`, `bankId`, `source="manual"`, `lockedByUser=true`.
- Якщо позначено "переказ між власними рахунками", операція автоматично маркується як внутрішня (`isTransfer=true`, `internalType="transfer"`) і не впливає на звіти.

## Де-дуплікація та внутрішні рухи

- Для кожної транзакції обчислюється `linkKey` (рахунки, абсолютна сума, час ±5 хвилин, нормалізований опис).
- Якщо дві події мають однаковий `bankId`, відбувається злиття без дублювання.
- Якщо `linkKey` збігається і суми протилежні, обидві позначаються як внутрішній переказ (`isTransfer=true`, `internalType="transfer"`).
- Інші збіги `linkKey` маркуються як дублікати (`duplicateOf=<itemId>`, `internalType="duplicate"`). 
- Для Monobank банок (`jarTopUp`/`jarWithdraw`) транзакції автоматично стають внутрішніми й виключаються з доходів/витрат.
- У таблиці "Операції" відображаються значки стану; для дубля доступна дія "Вирішити дубль" з опціями: злити, залишити обидва або позначити внутрішнім.

## Адаптивний інтерфейс

- Автоматичне визначення платформи (`getPlatformInfo`) додає `data-device` до `body` (desktop / ios / android).
- На мобільних пристроях фільтри та таблиця перебудовуються, непотрібні колонки приховуються.
- Для часткових дій використовується локальний спінер, усі сповіщення — через `uiModal`.
