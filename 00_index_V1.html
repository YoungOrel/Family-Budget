<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Домашній бюджет — Дашборд</title>
  <style>
    /* =====================
       THEME & TOKENS
       ===================== */
    :root{
      /* Yellow scale */
      --y-50:  #fefce8;
      --y-100: #fef9c2;
      --y-200: #fff085;
      --y-300: #ffdf20;
      --y-400: #fdc700;
      --y-500: #f0b100;
      --y-600: #d08700;
      --y-700: #a65f00;
      --y-800: #894b00;
      --y-900: #733e0a;
      --y-950: #432004;

      --bg: #0b0b0b;
      --card: #101214;
      --card-soft: #0d0f12;
      --text: #ffffff;
      --muted: #b7bdc6;
      --ok: #26d07c;
      --warn: var(--y-400);
      --danger: #ff5a5f;

      --outline: rgba(255,255,255,0.06);
      --shadow: 0 8px 24px rgba(0,0,0,0.35);

      /* Розміри та радіуси з пропорціями */
      --gap: 16px;
      --radius-xl: 20px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --radius-xs: 8px;   /* дрібні бейджі/лейбли */
    }

    /* Font: Century Gothic fallback stack */
    @font-face{font-family:"CenturyGothicLocal"; src: local("Century Gothic"), local("CenturyGothic"); font-weight:400; font-style:normal;}
    @font-face{font-family:"CenturyGothicLocal"; src: local("Century Gothic Bold"), local("CenturyGothic-Bold"); font-weight:700; font-style:bold;}

    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: CenturyGothicLocal, "Century Gothic", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing: 0.1px;
    }

    /* ====== Top Nav ====== */
    .topbar{
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; gap:12px;
      padding:12px 16px; background:linear-gradient(180deg, rgba(0,0,0,0.75), rgba(0,0,0,0.35));
      border-bottom:1px solid var(--outline);
      backdrop-filter: blur(8px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand-badge{ width:34px; height:34px; border-radius:10px; background:var(--y-400); display:grid; place-items:center; color:#000; font-weight:700; }
    .menu{ display:flex; gap:8px; margin-left:8px; flex-wrap: wrap; }
    .tab{ padding:8px 12px; border:1px solid var(--outline); border-radius:12px; cursor:pointer; user-select:none; }
    .tab[aria-current="page"]{ background:var(--card); }

    .spacer{ flex:1; }

    .toolbar{ display:flex; gap:8px; align-items:center; }
    .btn{ padding:9px 14px; border-radius:12px; border:1px solid var(--outline); background:var(--card); color:var(--text); cursor:pointer; box-shadow: var(--shadow); }
    .btn--primary{ background: var(--y-500); color:#111; border-color: transparent; }
    .btn--ghost{ background: transparent; border-color: var(--outline); }
    .nav-btn.active{ border-color:#ffcc00; color:#ffcc00; font-weight:700 }
    .view-pad{ padding:12px }

    /* ====== Page Head ====== */
    .page{ max-width: 1280px; margin: 0 auto; padding: 16px; }
    .head{
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-top:8px;
    }
    .title h1{ margin:0; font-size:28px; font-weight:700; }
    .title p{ margin:2px 0 0; color:var(--muted); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip{ display:flex; gap:8px; align-items:center; padding:8px 12px; border-radius:12px; background: var(--card); border:1px solid var(--outline); }
    select, .input{
      background: var(--card-soft); color: var(--text);
      border:1px solid var(--outline); border-radius:10px; padding:8px 10px; outline:none;
      font-family: inherit; font-size: 14px;
    }

    /* Уніфікуємо шрифт і для інших елементів вводу */
    input, button, select, textarea { font-family: inherit; }
    option { font-family: inherit; }

    /* ====== Content Layout ====== */
    .grid{ display:grid; gap: var(--gap); grid-template-columns: repeat(12, 1fr); margin-top: 16px; }
    .col-4{ grid-column: span 4; }
    .col-8{ grid-column: span 8; }
    .col-12{ grid-column: 1 / -1; }

    /* ====== Cards ====== */
    .card{
      background: var(--card); border: 1px solid var(--outline); border-radius: var(--radius-xl);
      padding: 16px; box-shadow: var(--shadow);
    }
    .card.soft{ background: linear-gradient(180deg, rgba(253, 199, 0, 0.08), transparent); }
    .card h3{ margin: 0 0 12px; font-size: 16px; color: var(--muted); font-weight:600; }

    /* ====== KPI GRID: 1 великий + 4 компактні ====== */
    .kpis{
      display:grid; gap: var(--gap);
      grid-template-columns: 1fr; /* мобільно */
    }
    @media (min-width: 1200px){
      .kpis{ grid-template-columns: repeat(12, 1fr); }
      .span-4{ grid-column: span 4; }
      .span-2{ grid-column: span 2; }
    }
    .kpi{ display:flex; flex-direction:column; justify-content:flex-start; padding:14px 16px;
          background: var(--card); border:1px solid var(--outline); border-radius: var(--radius-xl); box-shadow: var(--shadow); }
    .kpi--yellow{ background: var(--y-400); color:#111; border-color: transparent; }
    .kpi__label{ font-size:12px; line-height:1.2; color: var(--muted); }
    .kpi--yellow .kpi__label{ color:#1a1a1a; opacity: .85; }
    .kpi__value{ font-weight:700; font-size: clamp(18px, 2.0vw, 22px); line-height:1.1; margin-top:4px; }
    .kpi__delta{ margin-top:6px; font-size:12px; display:inline-flex; gap:8px; align-items:center; }
    .kpi__pct{
      margin-top:6px; font-size:12px;
      color: var(--muted);
    }
    .kpi__spacer{ flex: 1 1 auto; }   /* штовхає все нижче до низу */
    .kpi__pct{ margin-top:6px; font-size:12px; color: var(--muted); }
    .kpi__pct--up{ color: var(--ok); }
    .kpi__pct--down{ color: var(--danger); }

    /* Спарклайни */
    .spark{ height:26px; display:flex; color: #1a1a1a; align-items:flex-end; gap:4px; margin-top:6px; }
    .bar{ width:6px; border-radius:8px; background: rgba(255,255,255,.22); }
    .kpi--yellow .bar{ background: rgba(0,0,0,.2); }

    /* Δ бейджі: пропорційне заокруглення, не «капсули» */
    .delta{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius: var(--radius-xs);
            border:1px solid var(--outline); background:var(--card-soft); }
    .delta--up{ color: var(--ok); }
    .delta--down{ color: var(--danger); }
    .delta i{ font-style: normal; }
    /* Видимість секцій */
    .hidden{ display:none !important; }

    /* Локальний лоадер поверх блоку */
    .block-loader{
      position:absolute; inset:0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(1px);
      display:none; align-items:center; justify-content:center;
      border-radius: var(--radius-xl);
      z-index: 2;
    }
    .block-loader[aria-hidden="false"]{ display:flex; }
    .spinner{
      width:28px; height:28px; border-radius:50%;
      border:3px solid rgba(255,255,255,0.25);
      border-top-color: var(--y-400);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ====== Risk List ====== */
    .risk-list{ display:grid; gap:10px; }
    .risk-item{ display:flex; align-items:center; gap:12px; padding:12px; border-radius: var(--radius-lg);
                background:var(--card-soft); border:1px solid var(--outline); }
    .risk-rank{ width:28px; height:28px; border-radius: var(--radius-md); background: var(--y-400); color:#111;
                display:grid; place-items:center; font-weight:700; }
    .risk-name{ font-weight:700; }
    .risk-metrics{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    .badge{ padding:4px 8px; border-radius: var(--radius-xs); font-size:12px; border:1px solid var(--outline); background:var(--card); }
    .badge--danger{ background: rgba(255,90,95,.15); color:#ffb3b6; border-color: transparent; }
    .badge--warn{ background: rgba(253, 199, 0, .18); color: var(--y-300); border-color: transparent; }
    .badge--ok{ background: rgba(38,208,124,.15); color:#8de0b7; border-color: transparent; }

    /* ====== Table ====== */
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding:10px 8px; border-bottom:1px solid var(--outline); text-align:left; }
    th{ color: var(--muted); font-weight:600; font-size:13px; }
    .ops-loader{position:absolute;inset:0;z-index:10;display:flex;align-items:center;justify-content:center}
    .ops-loader__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px)}
    .ops-loader__card{position:relative;background:#141414;border:1px solid #222;border-radius:12px;padding:12px 16px;font-weight:700;color:#ffcc00}
    .ops-container{position:relative;}
    .ops-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;color:var(--muted);font-size:13px;}
    #ops-table-wrap{max-height:420px;overflow:auto;}
    #ops-pager{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
    .ops-table thead th{ position:sticky; top:0; background:#101010; z-index:2 }
    .progress{
      width: 100%; height:10px; background: rgba(255,255,255,0.06); border-radius: var(--radius-lg); overflow:hidden;
    }
    .progress > i{ display:block; height:100%; background: linear-gradient(90deg, var(--y-400), var(--y-700)); }
    .split-row{ display:flex; gap:8px; align-items:center; }
    .split-row .input.fund{ flex: 1 1 160px; }
    .split-row .input.amt{ width:110px; }
    .ops-card-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap;}
    .ops-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .chip--toggle{padding-inline:10px;}
    .toggle{display:flex;align-items:center;gap:8px;cursor:pointer;}
    .chip--toggle input{accent-color:var(--y-400);}
    .ops-badges{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .ops-badge{padding:2px 6px;border-radius:8px;font-size:11px;text-transform:uppercase;letter-spacing:0.3px;border:1px solid var(--outline);background:rgba(255,255,255,0.08);color:var(--muted);}
    .ops-badge--internal{background:rgba(253,199,0,0.16);color:var(--y-300);border-color:rgba(253,199,0,0.35);}
    .ops-badge--duplicate{background:rgba(255,90,95,0.18);color:#ffb3b6;border-color:rgba(255,90,95,0.35);}
    .ops-badge--transfer{background:rgba(38,208,124,0.18);color:#8de0b7;border-color:rgba(38,208,124,0.35);}
    .ops-row--muted{opacity:0.7;}
    .ops-table td.tags{font-size:12px;color:var(--muted);}
    .ops-table td.tags span{display:inline-block;background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:8px;margin-right:4px;margin-top:2px;}
    body[data-device="ios"], body[data-device="android"]{font-size:15px;}
    body[data-device="ios"] .btn, body[data-device="android"] .btn{padding:12px 16px;}
    body[data-device="ios"] .tab, body[data-device="android"] .tab{padding:10px 14px;}
    .manual-form{display:flex;flex-direction:column;gap:12px;}
    .manual-form .form-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .manual-form label{display:flex;flex-direction:column;gap:6px;font-size:13px;}
    .manual-form input, .manual-form select{background:var(--card-soft);color:var(--text);border:1px solid var(--outline);border-radius:8px;padding:8px 10px;}
    .manual-form .form-error{color:var(--danger);font-size:13px;}
    @media (max-width: 920px){
      .filters{flex-direction:column;align-items:stretch;gap:10px;}
      .filters .chip{width:100%;justify-content:space-between;}
      .filters .chip select, .filters .chip input{width:100%;margin-top:6px;}
      .ops-card-head{flex-direction:column;align-items:flex-start;gap:10px;}
      .ops-actions{width:100%;}
      .ops-actions .btn{flex:1 1 auto;text-align:center;}
    }
    @media (max-width: 768px){
      .ops-table th.col--mobile-hide, .ops-table td.col--mobile-hide{display:none;}
      #ops-table-wrap{max-height:none;}
      .page{padding:12px;}
      .filters{gap:8px;}
      .ops-toolbar{flex-direction:column;align-items:flex-start;gap:6px;}
    }
    .split-row .input.det{ flex: 2 1 220px; }
    .split-row .btn{ padding:6px 10px; }
    .split-editor{ display:grid; gap:12px; }
    .split-editor .split-rows{ display:flex; flex-direction:column; gap:8px; }
    .split-editor .split-error{ min-height:18px; font-size:13px; }
    /* відсотки в таблиці — «тихий» рядок під сумою */
    .sub{ margin-top:2px; font-size:12px; color: var(--muted); }
    .pct-badge{ display:inline-block; padding:2px 6px; border-radius: var(--radius-xs);
                border:1px solid var(--outline); background: var(--card-soft); margin-right:6px; }

    /* ====== Helpers ====== */
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; background: var(--y-100); color:#111; border-radius: var(--radius-md); font-weight:600; }
    .muted{ color: var(--muted); }
    /* ФІКС ДЛЯ СПЕЙСЕРА */
    .kpi {
      min-height: 140px;
    }

    /* ====== GLOBAL LOADER ====== */
    .global-loader {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(11, 11, 11, 0.95);
        backdrop-filter: blur(20px);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 28px;
    }

    .global-loader[aria-hidden="false"] {
        display: flex;
    }

    .global-spinner {
        display: none;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 3px solid rgba(253, 199, 0, 0.1);
        border-top-color: var(--y-400);
        animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
    }

    .global-loader-content {
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
    }

    .global-loader-text {
        color: var(--text);
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 0.4px;
    }

    .global-loader-subtext {
        color: var(--muted);
        font-size: 14px;
        opacity: 0.8;
    }

    .global-loader-progress {
        width: 200px;
        height: 4px;
        background: rgba(253, 199, 0, 0.15);
        border-radius: 4px;
        overflow: hidden;
    }

    .global-loader-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--y-400), var(--y-300));
        border-radius: 4px;
        width: 45%;
        animation: globalProgressSlide 2.2s ease-in-out infinite;
    }

    @keyframes globalProgressSlide {
        0% { transform: translateX(-100%); }
        50% { transform: translateX(200%); }
        100% { transform: translateX(-100%); }
    }
    
    /* === Modal (global, cautious) — UA: обережні підтвердження / EN: custom modal === */
    .modal-root{position:fixed;inset:0;z-index:1000}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .modal-card{position:relative;margin:8vh auto 0;max-width:520px;background:#141414;color:#f3f3f3;border:1px solid #222;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.6);padding:16px;display:flex;flex-direction:column;gap:12px}
    .modal-title{font-weight:700;font-size:18px}
    .modal-body{font-size:14px;color:#cfcfcf}
    .modal-actions{display:flex;justify-content:flex-end;gap:12px}
    .btn{border-radius:10px;padding:10px 14px;border:1px solid #2a2a2a;background:#1b1b1b;color:#f3f3f3;cursor:pointer}
    .btn--primary{background:#ffcc00;color:#0b0b0b;border-color:#ffcc00;font-weight:700}
    .btn:focus{outline:2px solid #ffcc00;outline-offset:2px}
    body.modal-open{overflow:hidden}

  </style>
</head>
<body>
<!-- === Global Modal (custom, cautious) =================================== -->
<div id="app-modal" aria-hidden="true" class="modal-root" style="display:none">
  <div class="modal-backdrop" data-modal-close></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="app-modal-title">
    <div class="modal-title" id="app-modal-title"></div>
    <div class="modal-body" id="app-modal-body"></div>
    <div class="modal-actions">
      <button class="btn btn--ghost" id="app-modal-cancel" data-modal-cancel>Скасувати</button>
      <button class="btn btn--primary" id="app-modal-ok" data-modal-ok>OK</button>
    </div>
  </div>
</div>
<!-- ======================================================================= -->
  <!-- ДОДАЙ ЦЕЙ БЛОК -->
  <div class="global-loader" id="global-loader" aria-hidden="true">
    <div class="global-spinner"></div>
    <div class="global-loader-content">
      <div class="global-loader-text">Завантаження дашборду</div>
      <div class="global-loader-subtext">Бюджетний дашборд</div>
      <div class="global-loader-progress">
        <div class="global-loader-progress-bar"></div>
      </div>
    </div>
  </div>
  <!-- ========= TOP BAR ========= -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-badge">₴</div>
      <div>Budget</div>
    </div>
    <nav class="menu" role="tablist">
      <button type="button" class="btn nav-btn" id="btnTabDashboard" data-tab-link="dashboard">Дашборд</button>
      <button type="button" class="btn nav-btn" id="btnTabOperations" data-tab-link="operations">Операції</button>
      <button type="button" class="btn nav-btn" id="btnTabFunds" data-tab-link="funds">Фонди</button>
      <button type="button" class="btn nav-btn" id="btnTabBudget" data-tab-link="budget">Бюджет по місяцях</button>
      <button type="button" class="btn nav-btn" id="btnTabSettings" data-tab-link="settings">Налаштування</button>
    </nav>
    <div class="spacer"></div>
    <div class="toolbar">
      <button class="btn btn--ghost" id="btn-rebuild">Перерахувати</button>
      <button class="btn btn--primary" id="btn-add">Додати</button>
    </div>
  </div>

  <main class="page">
    <section id="tab-dashboard" data-tab-content>
    <div class="head">
      <div class="title">
        <h1>Дашборд</h1>
        <p>План розподілу коштів vs фактичні розподілені та витрати по фондах.</p>
      </div>
      <div class="filters">
        <span class="chip">Місяць
          <select id="month-select"></select>
        </span>
        <span class="chip">Рік
          <select id="year-select"></select>
        </span>
        <span class="chip">
          <span class="pill">Тема: чорна · жовта</span>
        </span>
      </div>
    </div>

    <!-- ===== KPI tiles ===== -->
    <section class="kpis" style="margin-top:16px;">
      <!-- 1) Великий на 6 колонок -->
      <div class="kpi kpi--yellow span-4" id="kpi-income-plan">
        <div class="kpi__label">План надходжень</div>
        <div class="kpi__value" data-value>—</div>
        <div class="kpi__spacer"></div>   
        <div class="kpi__delta" data-delta></div>
      </div>

      <!-- 2–5) Компактні по 3 колонки -->
      <div class="kpi span-2" id="kpi-plan">
        <div class="kpi__label">План розподілу</div>
        <div class="kpi__value" data-value>—</div>
        <div class="spark" data-spark></div>
        <div class="kpi__spacer"></div>   
        <div class="kpi__pct" data-pct></div>   
        <div class="kpi__delta" data-delta></div>
      </div>

      <div class="kpi span-2" id="kpi-allocated">
        <div class="kpi__label">Розподілено</div>
        <div class="kpi__value" data-value>—</div>
        <div class="spark" data-spark></div>
        <div class="kpi__spacer"></div>   
        <div class="kpi__pct" data-pct></div>   
        <div class="kpi__delta" data-delta></div>
      </div>

      <div class="kpi span-2" id="kpi-spent">
        <div class="kpi__label">Витрачено</div>
        <div class="kpi__value" data-value>—</div>
        <div class="spark" data-spark></div>
        <div class="kpi__spacer"></div>   
        <div class="kpi__delta" data-delta></div>
      </div>

      <div class="kpi span-2" id="kpi-gap">
        <div class="kpi__label">Залишок</div>
        <div class="kpi__value" data-value>—</div>
        <div class="kpi__spacer"></div>   
        <div class="kpi__delta" data-delta></div>
      </div>
    </section>

    <div class="grid">
      <!-- TOP RISKS -->
      <section class="card col-4 soft">
        <h3>Топ ризики</h3>
        <div class="risk-list" id="risk-list"></div>
      </section>

      <!-- OVERVIEW TABLE -->
      <section class="card col-8">
        <h3>Фонди — план vs факт</h3>
        <div class="muted" style="margin-bottom:8px">Сортування: ризик (Spent/Allocated), потім Gap</div>
        <div class="table-wrap">
          <table id="overview">
            <thead>
              <tr>
                <th>Фонд</th>
                <th class="muted">План<br><span class="sub">частка в плані</span></th>
                <th>Розподілено<br><span class="sub">частка в розподілі</span></th>
                <th>Витрачено</th>
                <th>Gap</th>
                <th>Прогрес</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- RECENT TRANSACTIONS -->
      <section class="card col-12">
        <h3>Останні операції</h3>
        <table id="recent">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Фонд</th>
              <th>Сума</th>
              <th>Опис</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </section>
    <!-- ========= OPERATIONS VIEW ========= -->
    <section id="tab-operations" data-tab-content style="display:none;">
      <div class="head">
        <div class="title">
          <h1>Операції</h1>
          <p>Фільтруй по періоду та фонду. Дані вантажаться тільки в межах обраного періоду.</p>
        </div>
        <div class="filters">
          <span class="chip">Від
            <input type="date" id="ops-from" class="input" />
          </span>
          <span class="chip">До
            <input type="date" id="ops-to" class="input" />
          </span>
          <span class="chip">Фонд
            <select id="ops-fund" class="input">
              <option value="">Усі</option>
            </select>
          </span>
          <span class="chip">На сторінці
            <select id="ops-size" class="input">
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </span>
          <span class="chip chip--toggle">
            <label class="toggle">
              <input type="checkbox" id="ops-show-internal" />
              <span>Показувати внутрішні</span>
            </label>
          </span>
          <button class="btn" id="ops-apply">Застосувати</button>
        </div>
      </div>

      <section class="card ops-card" style="margin-top:16px; position:relative;">
        <div class="ops-card-head">
          <h3>Результати</h3>
          <div class="ops-actions">
            <button class="btn btn--primary" id="btn-new-tx">Нова операція</button>
            <button class="btn btn--ghost" id="btn-import-mono">Імпорт з Monobank</button>
          </div>
        </div>
        <div class="ops-container">
          <div class="ops-loader" id="ops-loader" aria-hidden="true" style="display:none">
            <div class="ops-loader__backdrop"></div>
            <div class="ops-loader__card">Завантаження…</div>
          </div>
          <div id="ops-toolbar" class="ops-toolbar"></div>
          <div id="ops-table-wrap">
            <table class="ops-table">
              <thead><tr id="ops-thead"></tr></thead>
              <tbody id="ops-tbody"></tbody>
            </table>
          </div>
          <div id="ops-pager"></div>
        </div>
      </section>
    </section>

    <section id="tab-funds" data-tab-content style="display:none">
      <div class="view-pad">
        <h2>Фонди</h2>
        <div id="funds-root">Готуємо дані фондів…</div>
      </div>
    </section>

    <section id="tab-budget" data-tab-content style="display:none">
      <div class="view-pad">
        <h2>Бюджет по місяцях</h2>
        <div id="budget-root">Готуємо бюджет…</div>
      </div>
    </section>

    <section id="tab-settings" data-tab-content style="display:none">
      <div class="view-pad">
        <h2>Налаштування</h2>
        <div id="settings-root">Готуємо налаштування…</div>
      </div>
    </section>

  </main>

  <script>
    // =====================
    //  DATA CONTRACT
    // =====================
    // getBootstrap() -> { settings: {activeYear}, ... }
    // getDashboard({year, month}) -> {
    //   monthKey: 'YYYY-MM',
    //   kpis: { plannedIncomesTotal, plannedTotal, allocatedTotal, spentTotal, mom:{...}, sparks:{planned,allocated,spent} },
    //   items: [ { fund, plan, allocated, spent, gap, score } ... ],
    //   recent: [ {date, fund, amount, details} ... ],
    //   months: ['2025-08','2025-09', ...]
    // }

    const isAppsScript = typeof google !== 'undefined' && google.script && google.script.run;

    /* ===== UI refs ===== */
    const UI = {
      month: document.getElementById('month-select'),
      year: document.getElementById('year-select'),
      riskList: document.getElementById('risk-list'),
      overviewBody: document.querySelector('#overview tbody'),
      recentBody: document.querySelector('#recent tbody'),
      kpis: {
        incomePlan: {
          value: document.querySelector('#kpi-income-plan [data-value]'),
          delta: document.querySelector('#kpi-income-plan [data-delta]')
        },
        plan: {
          value: document.querySelector('#kpi-plan [data-value]'),
          spark: document.querySelector('#kpi-plan [data-spark]'),
          pct:   document.querySelector('#kpi-plan [data-pct]'),  
          delta: document.querySelector('#kpi-plan [data-delta]')
        },
        allocated: {
          value: document.querySelector('#kpi-allocated [data-value]'),
          spark: document.querySelector('#kpi-allocated [data-spark]'),
          pct:   document.querySelector('#kpi-allocated [data-pct]'),
          delta: document.querySelector('#kpi-allocated [data-delta]')
        },
        spent: {
          value: document.querySelector('#kpi-spent [data-value]'),
          spark: document.querySelector('#kpi-spent [data-spark]'),
          delta: document.querySelector('#kpi-spent [data-delta]')
        },
        gap: {
          value: document.querySelector('#kpi-gap [data-value]'),
          delta: document.querySelector('#kpi-gap [data-delta]')
        }
      }
    };

    // ===== GLOBAL LOADER =====
    function showLoader(show) {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.style.display = show ? 'flex' : 'none';
        }
    }

    let BOOT = null;
    let CURRENT = {year: null, month: null};
    const OPS_DICTIONARIES = { funds: [], accounts: [], categories: [] };

    /* ===== Utils ===== */
    function fmtMoney(x){
      if (x === undefined || x === null || isNaN(x)) return '—';
      return new Intl.NumberFormat('uk-UA',{style:'currency', currency:'UAH', maximumFractionDigits:0}).format(Number(x));
    }
    function renderDelta(el, delta, goodMode){
      // goodMode: 'up' або 'down' — що вважаємо «краще»
      el.innerHTML = '';
      if (delta === null || delta === undefined) { el.textContent = '—'; return; }
      const up = delta > 0;
      const cls = up ? 'delta--up' : 'delta--down';
      const wrap = document.createElement('span');
      wrap.className = `delta ${cls}`;
      const arrow = up ? '▲' : '▼';
      const sign = delta>0 ? '+' : '−';
      wrap.innerHTML = `<i>${arrow}</i> ${sign}${fmtMoney(Math.abs(delta))}`;
      el.appendChild(wrap);
    }
    function spark(container, arr){
      if (!container) return;
      container.innerHTML = '';
      const max = Math.max(1, ...arr.map(v=>Math.abs(v)));
      arr.forEach(v=>{
        const b = document.createElement('div');
        b.className = 'bar';
        b.style.height = (6 + (Math.abs(v)/max)*28) + 'px';
        container.appendChild(b);
      });
    }

    function callServer(method, payload){
      if (!isAppsScript){
        return Promise.reject(new Error('Apps Script середовище недоступне.')); 
      }
      return new Promise((resolve, reject) => {
        const runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject);
        if (typeof runner[method] !== 'function'){
          reject(new Error(`Метод ${method} недоступний на сервері`));
          return;
        }
        runner[method](payload);
      });
    }

    function applyPlatformClass(info){
      const device = info && info.device ? info.device : 'desktop';
      document.body.dataset.device = device;
    }

    function addToDictionary(arr, value){
      if (!Array.isArray(arr)) return;
      const v = String(value || '').trim();
      if (!v) return;
      if (!arr.includes(v)) arr.push(v);
    }

    function escapeHtml(value){
      return String(value || '').replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch] || ch));
    }

    function absorbDictionaryFromItems(items){
      if (!Array.isArray(items)) return;
      items.forEach(item => {
        addToDictionary(OPS_DICTIONARIES.accounts, item && item.account);
        addToDictionary(OPS_DICTIONARIES.funds, item && item.fund);
        addToDictionary(OPS_DICTIONARIES.categories, item && item.category);
      });
    }

    /* ===== Render ===== */
    function renderDashboard(model){
      console.log('snapshot?:', model && model._snapshot, 'cached flag:', model && model._cached);

      // KPIs (значення)
      UI.kpis.incomePlan.value.textContent = fmtMoney(model.kpis.plannedIncomesTotal);
      UI.kpis.plan.value.textContent        = fmtMoney(model.kpis.plannedTotal);
      UI.kpis.allocated.value.textContent   = fmtMoney(model.kpis.allocatedTotal);
      UI.kpis.spent.value.textContent       = fmtMoney(model.kpis.spentTotal);

      // Відсотки від плану надходжень (для Плану і Розподілено)
      const r = model.kpis.ratios || {};
      function pctStr(x){ return (x==null) ? '—' : (Math.round(x*1000)/10).toFixed(1) + '%'; }

      UI.kpis.plan.pct.textContent       = pctStr((model.kpis.ratios||{}).planPctOfIncome);
      UI.kpis.allocated.pct.textContent  = pctStr((model.kpis.ratios||{}).allocatedPctOfPlan);  // <— ОНОВЛЕНО

      // Підсвітка тренду % (MoM): більше — зелений, менше — червоний
      const rp = (model.kpis.mom && model.kpis.mom.ratios) || {};
      UI.kpis.plan.pct.classList.remove('kpi__pct--up','kpi__pct--down');
      UI.kpis.allocated.pct.classList.remove('kpi__pct--up','kpi__pct--down');
      if (rp.planPctDelta != null){
        UI.kpis.plan.pct.classList.add(rp.planPctDelta > 0 ? 'kpi__pct--up' : 'kpi__pct--down');
      }
      if (rp.allocatedPctDelta != null){
        UI.kpis.allocated.pct.classList.add(rp.allocatedPctDelta > 0 ? 'kpi__pct--up' : 'kpi__pct--down');
      }


      // Gap = Allocated - Spent
      const gap = Number(model.kpis.allocatedTotal||0) - Number(model.kpis.spentTotal||0);
      UI.kpis.gap.value.textContent         = fmtMoney(gap);

      // Спарклайни
      const s = model.kpis.sparks || {};
      spark(UI.kpis.plan.spark,      s.planned || []);
      spark(UI.kpis.allocated.spark, s.allocated || []);
      spark(UI.kpis.spent.spark,     s.spent || []);

      // МоМ-дельти (до такого ж дня попереднього місяця)
      const mom = model.kpis.mom || {};
      renderDelta(UI.kpis.incomePlan.delta, mom.incomes,   'up');   // більше плану надходжень — краще
      renderDelta(UI.kpis.plan.delta,       mom.planDist,  'up');   // більше планового розподілу — ок
      renderDelta(UI.kpis.allocated.delta,  mom.allocated, 'up');   // більше розподілено — краще
      renderDelta(UI.kpis.spent.delta,      mom.spent,     'down'); // більше витрачено — гірше
      const momGap = (mom.allocated ?? 0) - (mom.spent ?? 0);
      renderDelta(UI.kpis.gap.delta, momGap, 'up'); // більший позитивний геп — краще

      // Risk list (top 5)
      UI.riskList.innerHTML = '';
      (model.items||[]).slice(0,5).forEach((row, idx)=>{
        const el = document.createElement('div');
        el.className = 'risk-item';
        const badgeClass = row.spent > row.allocated ? 'badge badge--danger'
                          : (row.spent >= 0.8*row.allocated ? 'badge badge--warn' : 'badge badge--ok');
        el.innerHTML = `
          <div class="risk-rank">${idx+1}</div>
          <div>
            <div class="risk-name">${row.fund}</div>
            <div class="muted">План ${fmtMoney(row.plan)} · Розподілено ${fmtMoney(row.allocated)}</div>
          </div>
          <div class="risk-metrics">
            <span class="${badgeClass}">Витрачено: ${fmtMoney(row.spent)}</span>
            <span class="badge">Відхилення: ${fmtMoney(row.gap)}</span>
          </div>`;
        UI.riskList.appendChild(el);
      });

      // Overview table
      UI.overviewBody.innerHTML = '';
      (model.items||[]).forEach(row=>{
        const tr = document.createElement('tr');
        const progress = Math.min(1, row.spent / Math.max(row.allocated, 1e-9));
        tr.innerHTML = `
          <td><strong>${row.fund}</strong></td>
          <td class="muted">
            ${fmtMoney(row.plan)}
            <div class="sub"><span class="pct-badge">${Math.round(row.planPct*100)}%</span></div>
          </td>
          <td>
            ${fmtMoney(row.allocated)}
            <div class="sub"><span class="pct-badge">${Math.round(row.allocatedPct*100)}%</span></div>
          </td>
          <td>${fmtMoney(row.spent)}</td>
          <td>${fmtMoney(row.gap)}</td>
          <td><div class="progress"><i style="width:${(progress*100).toFixed(1)}%"></i></div></td>`;

        UI.overviewBody.appendChild(tr);
      });

      // Recent transactions
      UI.recentBody.innerHTML = '';
      (model.recent||[]).forEach(tx=>{
        const tr = document.createElement('tr');
        const d = new Date(tx.date);
        tr.innerHTML = `
          <td>${d.toLocaleDateString('uk-UA')}</td>
          <td>${tx.fund||'—'}</td>
          <td>${fmtMoney(tx.amount)}</td>
          <td>${tx.details||''}</td>`;
        UI.recentBody.appendChild(tr);
      });
    }

    /* ===== Data flow ===== */
    function fillMonths(year, months){
      UI.year.innerHTML = '';
      const yopt = document.createElement('option');
      yopt.value = String(year); yopt.textContent = String(year);
      UI.year.appendChild(yopt);

      UI.month.innerHTML = '';
      months.forEach(m=>{
        const o = document.createElement('option');
        o.value = m; // 'YYYY-MM'
        const [yy,mm] = m.split('-');
        const dt = new Date(Number(yy), Number(mm)-1, 1);
        o.textContent = dt.toLocaleString('uk-UA',{ month:'long', year:'numeric' });
        UI.month.appendChild(o);
      });
    }

    async function loadDashboard(){
        if (!CURRENT.year || !CURRENT.month) return;

        showLoader(true);
        try {
            if (isAppsScript){
                const model = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getDashboard({ year: CURRENT.year, month: CURRENT.month });
                });
                renderDashboard(model);
            } else {
                renderDashboard(buildMock());
            }
        } catch (err) {
            const message = String((err && err.message) || err || 'Помилка завантаження');
            if (window.uiModal && typeof window.uiModal.alert === 'function'){
                await window.uiModal.alert(message, 'Помилка');
            } else if (typeof window.alert === 'function'){
                window.alert(message);
            }
        } finally {
            showLoader(false);
        }
    }


    const TABS = {
      dashboard: { btn: '#btnTabDashboard', sec: '#tab-dashboard' },
      operations:{ btn: '#btnTabOperations', sec: '#tab-operations' },
      funds:     { btn: '#btnTabFunds',     sec: '#tab-funds' },
      budget:    { btn: '#btnTabBudget',    sec: '#tab-budget' },
      settings:  { btn: '#btnTabSettings',  sec: '#tab-settings' }
    };

    function qs(sel){ return document.querySelector(sel); }

    // ===== OPERATIONS VIEW =====
    const OPS_STATE = {
      page: 1,
      lastMeta: null,
      showInternal: false
    };

    function showTab(name){
      Object.keys(TABS).forEach(key => {
        const tabConf = TABS[key];
        const section = qs(tabConf.sec);
        if (section){
          section.style.display = (key === name) ? 'block' : 'none';
        }
        const button = qs(tabConf.btn);
        if (button){
          button.classList.toggle('active', key === name);
        }
      });
      try { location.hash = '#' + name; } catch (err) {}
      if (name === 'operations' && typeof loadOperationsIfNeeded === 'function'){
        loadOperationsIfNeeded();
      }
      if (name === 'funds' && typeof loadFundsIfNeeded === 'function'){
        loadFundsIfNeeded();
      }
      if (name === 'budget' && typeof loadBudgetIfNeeded === 'function'){
        loadBudgetIfNeeded();
      }
      if (name === 'settings' && typeof loadSettingsIfNeeded === 'function'){
        loadSettingsIfNeeded();
      }
    }

    function setupTabs(){
      Object.keys(TABS).forEach(key => {
        const btn = qs(TABS[key].btn);
        if (!btn) return;
        btn.addEventListener('click', () => showTab(key));
      });
    }

    function showOpsLoader(){
      const loader = document.getElementById('ops-loader');
      if (loader){
        loader.style.display = 'flex';
        loader.setAttribute('aria-hidden','false');
      }
    }

    function hideOpsLoader(){
      const loader = document.getElementById('ops-loader');
      if (loader){
        loader.style.display = 'none';
        loader.setAttribute('aria-hidden','true');
      }
    }

    function ensureOpsDefaultPeriod(){
      const fromInput = document.getElementById('ops-from');
      const toInput = document.getElementById('ops-to');
      if (!fromInput || !toInput) return;
      if (!fromInput.value && !toInput.value){
        const now = new Date();
        const from = new Date(now.getFullYear(), now.getMonth(), 1);
        const to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        fromInput.value = from.toISOString().slice(0,10);
        toInput.value = to.toISOString().slice(0,10);
      }
    }

    function populateOpsFunds(funds){
      const select = document.getElementById('ops-fund');
      if (!select || !Array.isArray(funds)) return;
      const existing = new Set(Array.from(select.options || []).map(opt => opt.value));
      funds.forEach(fund => {
        const value = String(fund || '').trim();
        if (!value || existing.has(value)) return;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
        existing.add(value);
      });
    }

    function collectOpsFilters(){
      const fromInput = document.getElementById('ops-from');
      const toInput = document.getElementById('ops-to');
      const fundSelect = document.getElementById('ops-fund');
      const sizeSelect = document.getElementById('ops-size');
      const internalToggle = document.getElementById('ops-show-internal');
      const from = fromInput && fromInput.value ? fromInput.value : null;
      const to = toInput && toInput.value ? toInput.value : null;
      const fund = fundSelect ? String(fundSelect.value || '').trim() : '';
      const sizeValue = sizeSelect && sizeSelect.value ? Number(sizeSelect.value) : 50;
      const size = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : 50;
      const showInternal = internalToggle ? internalToggle.checked : false;
      return { from, to, fund, size, showInternal };
    }

    function buildOptionsHtml(items, placeholder){
      const list = Array.isArray(items) ? items : [];
      let html = '';
      if (placeholder){
        html += `<option value="">${escapeHtml(placeholder)}</option>`;
      }
      list.forEach(value => {
        const safe = escapeHtml(value);
        html += `<option value="${safe}">${safe}</option>`;
      });
      return html;
    }

    async function openManualTxModal(){
      const formId = `manual-tx-${Date.now()}`;
      const errorId = `${formId}-error`;
      const hasAccounts = Array.isArray(OPS_DICTIONARIES.accounts) && OPS_DICTIONARIES.accounts.length > 0;
      const hasFunds = Array.isArray(OPS_DICTIONARIES.funds) && OPS_DICTIONARIES.funds.length > 0;
      const hasCategories = Array.isArray(OPS_DICTIONARIES.categories) && OPS_DICTIONARIES.categories.length > 0;
      const accountControl = hasAccounts
        ? `<select name="account" required>${buildOptionsHtml(OPS_DICTIONARIES.accounts, 'Оберіть рахунок')}</select>`
        : `<input type="text" name="account" placeholder="Рахунок" required />`;
      const fundControl = hasFunds
        ? `<select name="fund" required>${buildOptionsHtml(OPS_DICTIONARIES.funds, 'Оберіть фонд')}</select>`
        : `<input type="text" name="fund" placeholder="Фонд" required />`;
      const categoryControl = hasCategories
        ? `<select name="category" required>${buildOptionsHtml(OPS_DICTIONARIES.categories, 'Категорія')}</select>`
        : `<input type="text" name="category" placeholder="Категорія" required />`;
      const linkedControl = hasAccounts
        ? `<select name="linkedAccount" disabled>${buildOptionsHtml(OPS_DICTIONARIES.accounts, 'Оберіть рахунок')}</select>`
        : `<input type="text" name="linkedAccount" placeholder="Пов’язаний рахунок" disabled />`;
      const html = `
        <form id="${formId}" class="manual-form" autocomplete="off">
          <div class="form-grid">
            <label>Дата<input type="date" name="date" required /></label>
            <label>Рахунок${accountControl}</label>
            <label>Фонд${fundControl}</label>
            <label>Категорія${categoryControl}</label>
            <label>Сума<input type="number" step="0.01" name="amount" required /></label>
            <label>Деталі<input type="text" name="details" placeholder="Опис або мерчант" /></label>
            <label>Коментар<input type="text" name="comment" placeholder="Коментар" /></label>
            <label>Теги<input type="text" name="tags" placeholder="через кому" /></label>
          </div>
          <label class="toggle" style="margin-top:12px;">
            <input type="checkbox" name="isTransfer" />
            <span>Переказ між власними рахунками</span>
          </label>
          <label style="display:block;margin-top:8px;">
            Пов’язаний рахунок
            ${linkedControl}
          </label>
          <div class="muted" style="margin-top:8px;font-size:12px;">Прикріплення файлів наразі не підтримується.</div>
          <div class="form-error" id="${errorId}"></div>
        </form>`;

      let saved = false;
      const ok = await uiModal.custom({
        title: 'Нова операція',
        body: html,
        okText: 'Зберегти',
        showCancel: true,
        trap: false,
        onOpen: ({ bodyEl }) => {
          const form = bodyEl.querySelector(`#${formId}`);
          if (!form) return;
          const dateInput = form.querySelector('input[name="date"]');
          if (dateInput && !dateInput.value){
            dateInput.value = new Date().toISOString().slice(0,10);
          }
          const transferCheckbox = form.querySelector('input[name="isTransfer"]');
          const linkedField = form.querySelector('[name="linkedAccount"]');
          if (transferCheckbox && linkedField){
            transferCheckbox.addEventListener('change', () => {
              linkedField.disabled = !transferCheckbox.checked;
            });
          }
        },
        beforeOk: async ({ bodyEl }) => {
          const form = bodyEl.querySelector(`#${formId}`);
          const errorBox = bodyEl.querySelector(`#${errorId}`);
          if (errorBox) errorBox.textContent = '';
          if (!form) return false;
          const formData = new FormData(form);
          const payload = {
            date: formData.get('date'),
            account: formData.get('account'),
            fund: formData.get('fund'),
            category: formData.get('category'),
            amount: formData.get('amount'),
            details: formData.get('details'),
            comment: formData.get('comment'),
            tags: formData.get('tags'),
            isTransfer: formData.get('isTransfer') === 'on',
            linkedAccount: formData.get('linkedAccount')
          };
          if (payload.isTransfer && !payload.linkedAccount){
            if (errorBox) errorBox.textContent = 'Для переказу вкажіть пов’язаний рахунок.';
            return false;
          }
          showOpsLoader();
          try {
            const res = await callServer('createManualTransaction', payload);
            saved = true;
            addToDictionary(OPS_DICTIONARIES.accounts, payload.account);
            addToDictionary(OPS_DICTIONARIES.accounts, payload.linkedAccount);
            addToDictionary(OPS_DICTIONARIES.funds, payload.fund);
            addToDictionary(OPS_DICTIONARIES.categories, payload.category);
            populateOpsFunds([payload.fund]);
            OPS_STATE.page = 1;
            await loadOperations();
            return true;
          } catch (err) {
            const message = (err && err.message) ? err.message : String(err || 'Не вдалося зберегти операцію');
            if (errorBox) errorBox.textContent = message;
            return false;
          } finally {
            hideOpsLoader();
          }
        }
      });
      if (ok && saved){
        await uiModal.alert('Операцію збережено успішно.', 'Готово');
      }
    }

    async function openImportMonoModal(){
      const formId = `mono-import-${Date.now()}`;
      const errorId = `${formId}-error`;
      const html = `
        <form id="${formId}" class="manual-form" autocomplete="off">
          <label>Період з<input type="date" name="from" required /></label>
          <label>по<input type="date" name="to" required /></label>
          <div class="form-error" id="${errorId}"></div>
        </form>`;
      let importedSummary = null;
      const ok = await uiModal.custom({
        title: 'Імпорт з Monobank',
        body: html,
        okText: 'Імпортувати',
        showCancel: true,
        onOpen: ({ bodyEl }) => {
          const form = bodyEl.querySelector(`#${formId}`);
          if (!form) return;
          const to = new Date();
          const from = new Date(to.getTime() - 29*24*60*60*1000);
          const fromInput = form.querySelector('input[name="from"]');
          const toInput = form.querySelector('input[name="to"]');
          if (fromInput && !fromInput.value){ fromInput.value = from.toISOString().slice(0,10); }
          if (toInput && !toInput.value){ toInput.value = to.toISOString().slice(0,10); }
        },
        beforeOk: async ({ bodyEl }) => {
          const form = bodyEl.querySelector(`#${formId}`);
          const errorBox = bodyEl.querySelector(`#${errorId}`);
          if (errorBox) errorBox.textContent = '';
          if (!form) return false;
          const formData = new FormData(form);
          const payload = {
            from: formData.get('from'),
            to: formData.get('to')
          };
          showOpsLoader();
          try {
            const res = await callServer('importMonobankStatement', payload);
            importedSummary = res;
            if (Array.isArray(res && res.accounts)){
              res.accounts.forEach(acc => addToDictionary(OPS_DICTIONARIES.accounts, acc && acc.name));
            }
            OPS_STATE.page = 1;
            await loadOperations();
            return true;
          } catch (err) {
            const message = (err && err.message) ? err.message : String(err || 'Не вдалося імпортувати виписку');
            if (errorBox) errorBox.textContent = message;
            return false;
          } finally {
            hideOpsLoader();
          }
        }
      });
      if (ok && importedSummary){
        const text = `Імпортовано: ${importedSummary.imported || 0}\nОновлено: ${importedSummary.updated || 0}\nПозначено дублем/внутрішніх: ${importedSummary.duplicates || 0}`;
        await uiModal.alert(text.replace(/\n/g, '<br>'), 'Імпорт завершено');
      }
    }

    async function openDuplicateResolver(itemId){
      if (!itemId) return;
      const items = Array.isArray(window.__opsLastItems) ? window.__opsLastItems : [];
      const item = items.find(row => String(row.itemId || row.id || '') === itemId);
      if (!item){
        await uiModal.alert('Не знайдено дані транзакції для обробки дубля.', 'Помилка');
        return;
      }
      const formId = `dupe-${Date.now()}`;
      const html = `
        <form id="${formId}" class="manual-form" style="display:grid;gap:12px;">
          <div class="muted">${item.details || ''}</div>
          <label class="toggle"><input type="radio" name="dupe" value="merge" checked /><span>Злити (залишити один запис)</span></label>
          <label class="toggle"><input type="radio" name="dupe" value="keepBoth" /><span>Залишити обидва</span></label>
          <label class="toggle"><input type="radio" name="dupe" value="markInternal" /><span>Позначити як внутрішній</span></label>
        </form>`;
      let resolved = false;
      const ok = await uiModal.custom({
        title: 'Розв’язання дубля',
        body: html,
        okText: 'Застосувати',
        showCancel: true,
        beforeOk: async ({ bodyEl }) => {
          const form = bodyEl.querySelector(`#${formId}`);
          if (!form) return false;
          const formData = new FormData(form);
          const action = formData.get('dupe');
          showOpsLoader();
          try {
            await callServer('resolveDuplicate', { itemId, action });
            resolved = true;
            await loadOperations();
            return true;
          } catch (err) {
            const message = (err && err.message) ? err.message : String(err || 'Не вдалося оновити запис');
            await uiModal.alert(message, 'Помилка');
            return false;
          } finally {
            hideOpsLoader();
          }
        }
      });
      if (ok && resolved){
        await uiModal.alert('Оновлено стан дубля.', 'Готово');
      }
    }

    function renderOperations(items){
      const headRow = document.getElementById('ops-thead');
      const body = document.getElementById('ops-tbody');
      if (!headRow || !body) return;
      const columns = [
        { key: 'date', label: 'Дата' },
        { key: 'account', label: 'Рахунок' },
        { key: 'fund', label: 'Фонд' },
        { key: 'category', label: 'Категорія', mobileHide: true },
        { key: 'amount', label: 'Сума' },
        { key: 'details', label: 'Деталі' },
        { key: 'status', label: 'Статус', mobileHide: true },
        { key: 'tags', label: 'Мітки', mobileHide: true },
        { key: 'comment', label: 'Коментар', mobileHide: true },
        { key: 'actions', label: 'Дії' }
      ];
      headRow.innerHTML = '';
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.label;
        if (col.mobileHide) th.classList.add('col--mobile-hide');
        headRow.appendChild(th);
      });

      body.innerHTML = '';
      const list = Array.isArray(items) ? items : [];
      const filtered = list.filter(item => {
        if (!OPS_STATE.showInternal && item.isInternal){
          return false;
        }
        return true;
      });

      filtered.forEach(item => {
        const tr = document.createElement('tr');
        const isDuplicate = !!item.duplicateOf || item.internalType === 'duplicate';
        const isInternal = !!item.isInternal;
        if (isDuplicate || isInternal){
          tr.classList.add('ops-row--muted');
        }

        const dateCell = document.createElement('td');
        dateCell.textContent = item && item.date ? new Date(item.date).toLocaleDateString('uk-UA') : '—';
        tr.appendChild(dateCell);

        const accountCell = document.createElement('td');
        accountCell.textContent = item && item.account ? item.account : '—';
        tr.appendChild(accountCell);

        const fundCell = document.createElement('td');
        fundCell.textContent = item && item.fund ? item.fund : '—';
        tr.appendChild(fundCell);

        const categoryCell = document.createElement('td');
        categoryCell.textContent = item && item.category ? item.category : '—';
        categoryCell.classList.add('col--mobile-hide');
        tr.appendChild(categoryCell);

        const amountCell = document.createElement('td');
        const amountValue = Number(item && item.amount);
        amountCell.textContent = fmtMoney(Number.isFinite(amountValue) ? amountValue : 0);
        if (Number.isFinite(amountValue)){
          if (amountValue > 0) amountCell.style.color = 'var(--ok)';
          if (amountValue < 0) amountCell.style.color = 'var(--danger)';
        }
        tr.appendChild(amountCell);

        const detailsCell = document.createElement('td');
        const detailParts = [];
        if (item && item.details) detailParts.push(item.details);
        if (item && item.mcc) detailParts.push(`MCC ${item.mcc}`);
        detailsCell.textContent = detailParts.join(' · ');
        tr.appendChild(detailsCell);

        const statusCell = document.createElement('td');
        statusCell.classList.add('col--mobile-hide');
        const badges = document.createElement('div');
        badges.className = 'ops-badges';
        if (item && item.source){
          const b = document.createElement('span');
          b.className = 'ops-badge';
          b.textContent = item.source === 'mono' ? 'Monobank' : item.source;
          badges.appendChild(b);
        }
        if (isInternal){
          const b = document.createElement('span');
          b.className = 'ops-badge ops-badge--internal';
          b.textContent = 'Внутрішня';
          badges.appendChild(b);
          if (item.internalType === 'jarTopUp' || item.internalType === 'jarWithdraw'){
            const b2 = document.createElement('span');
            b2.className = 'ops-badge ops-badge--transfer';
            b2.textContent = item.internalType === 'jarTopUp' ? 'Jar ↑' : 'Jar ↓';
            badges.appendChild(b2);
          }
          if (item.isTransfer || item.internalType === 'transfer'){
            const b3 = document.createElement('span');
            b3.className = 'ops-badge ops-badge--transfer';
            b3.textContent = 'Переказ';
            badges.appendChild(b3);
            if (item.linkedAccount){
              const b4 = document.createElement('span');
              b4.className = 'ops-badge';
              b4.textContent = `↔ ${item.linkedAccount}`;
              badges.appendChild(b4);
            }
          }
        }
        if (isDuplicate){
          const b = document.createElement('span');
          b.className = 'ops-badge ops-badge--duplicate';
          b.textContent = 'Дубль';
          badges.appendChild(b);
        }
        if (!badges.childElementCount){
          const b = document.createElement('span');
          b.className = 'ops-badge';
          b.textContent = 'Факт';
          badges.appendChild(b);
        }
        statusCell.appendChild(badges);
        tr.appendChild(statusCell);

        const tagsCell = document.createElement('td');
        tagsCell.className = 'tags col--mobile-hide';
        const tags = Array.isArray(item && item.tags) ? item.tags : [];
        if (tags.length){
          tags.forEach(tag => {
            const span = document.createElement('span');
            span.textContent = tag;
            tagsCell.appendChild(span);
          });
        } else {
          tagsCell.textContent = '—';
        }
        tr.appendChild(tagsCell);

        const commentCell = document.createElement('td');
        commentCell.textContent = item && item.comment ? item.comment : '';
        commentCell.classList.add('col--mobile-hide');
        tr.appendChild(commentCell);

        const actionsCell = document.createElement('td');
        actionsCell.textContent = '';
        const rawItemId = item && (item.itemId ?? '');
        const rawId = item && (item.id ?? '');
        const rawBankId = item && (item.bankId ?? '');
        const txId = item ? (item.itemId || item.id || item.txId || '') : '';
        const bankId = item ? (item.bankId || item.id || item.groupId || '') : '';
        const splitBtn = document.createElement('button');
        splitBtn.className = 'btn btn--ghost btn-split';
        splitBtn.textContent = 'Рознести';
        splitBtn.setAttribute('data-tx-id', String(txId || ''));
        splitBtn.setAttribute('data-bank-id', String(bankId || ''));
        splitBtn.setAttribute('title', `itemId=${rawItemId}; id=${rawId}; bankId=${rawBankId}`);
        actionsCell.appendChild(splitBtn);

        if (isDuplicate){
          const resolveBtn = document.createElement('button');
          resolveBtn.className = 'btn btn--ghost btn-resolve-duplicate';
          resolveBtn.textContent = 'Вирішити дубль';
          resolveBtn.dataset.itemId = item.itemId || '';
          actionsCell.appendChild(resolveBtn);
        }

        tr.appendChild(actionsCell);
        body.appendChild(tr);
      });
    }

    function updateOpsPager(meta){
      const pager = document.getElementById('ops-pager');
      if (!pager) return;
      const toolbar = document.getElementById('ops-toolbar');
      if (toolbar){
        toolbar.textContent = meta ? `Всього записів: ${meta.total || 0}` : 'Всього записів: —';
      }
      pager.innerHTML = '';
      if (!meta){
        pager.textContent = '—';
        return;
      }
      const info = document.createElement('div');
      info.className = 'muted';
      info.textContent = `Сторінка ${meta.page}/${meta.pages} · Записів: ${meta.total}`;
      pager.appendChild(info);

      if (meta.pages > 1){
        const controls = document.createElement('div');
        controls.style.display = 'flex';
        controls.style.gap = '8px';
        controls.style.marginTop = '8px';

        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn--ghost';
        prevBtn.textContent = 'Назад';
        prevBtn.disabled = meta.page <= 1;
        prevBtn.addEventListener('click', () => {
          if (meta.page > 1){
            OPS_STATE.page = meta.page - 1;
            loadOperations();
          }
        });
        controls.appendChild(prevBtn);

        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn--ghost';
        nextBtn.textContent = 'Вперед';
        nextBtn.disabled = meta.page >= meta.pages;
        nextBtn.addEventListener('click', () => {
          if (meta.page < meta.pages){
            OPS_STATE.page = meta.page + 1;
            loadOperations();
          }
        });
        controls.appendChild(nextBtn);

        pager.appendChild(controls);
      }
    }

    async function loadOperations(){
      ensureOpsDefaultPeriod();
      const filters = collectOpsFilters();
      const year = CURRENT.year || (new Date()).getFullYear();
      OPS_STATE.showInternal = !!filters.showInternal;
      const params = {
        year,
        from: filters.from,
        to: filters.to,
        fund: filters.fund || null,
        page: OPS_STATE.page || 1,
        size: filters.size || 50
      };
      showOpsLoader();
      try {
        if (isAppsScript){
          const res = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getTransactionsView(params);
          });
          const meta = res && res.meta ? res.meta : null;
          const items = (res && res.items) || res || [];
          window.__opsLastItems = Array.isArray(items) ? items.slice() : [];
          absorbDictionaryFromItems(window.__opsLastItems);
          OPS_STATE.lastMeta = meta;
          if (meta && typeof meta.page === 'number') {
            OPS_STATE.page = meta.page;
          }
          renderOperations(items);
          updateOpsPager(meta);
        } else {
          const mock = buildMock();
          const mockItems = Array.isArray(mock && mock.recent) ? mock.recent.map(row => ({
            date: row.date,
            fund: row.fund,
            category: row.category || '—',
            amount: row.amount,
            details: row.details || '',
            comment: row.comment || ''
          })) : [];
          window.__opsLastItems = mockItems.slice();
          absorbDictionaryFromItems(window.__opsLastItems);
          OPS_STATE.lastMeta = { page: 1, pages: 1, total: mockItems.length, size: filters.size };
          OPS_STATE.page = OPS_STATE.lastMeta.page;
          renderOperations(mockItems);
          updateOpsPager(OPS_STATE.lastMeta);
        }
      } catch (err) {
        const message = String((err && err.message) || err || 'Помилка завантаження');
        if (window.uiModal && typeof window.uiModal.alert === 'function'){
          await window.uiModal.alert(message, 'Помилка');
        } else if (typeof window.alert === 'function'){
          window.alert(message);
        }
      } finally {
        hideOpsLoader();
      }
    }

    function loadOperationsIfNeeded(){
      if (window.__opsInited === true) return;
      window.__opsInited = true;
      OPS_STATE.page = 1;
      const sizeSelect = document.getElementById('ops-size');
      if (sizeSelect && !sizeSelect.value){
        sizeSelect.value = '50';
      }
      loadOperations();
    }

    function setupOperationsUi(){
      const applyBtn = document.getElementById('ops-apply');
      if (applyBtn){
        applyBtn.addEventListener('click', () => {
          OPS_STATE.page = 1;
          loadOperations();
        });
      }
      const newBtn = document.getElementById('btn-new-tx');
      if (newBtn){
        newBtn.addEventListener('click', () => {
          openManualTxModal();
        });
      }
      const importBtn = document.getElementById('btn-import-mono');
      if (importBtn){
        importBtn.addEventListener('click', () => {
          openImportMonoModal();
        });
      }
      const internalToggle = document.getElementById('ops-show-internal');
      if (internalToggle){
        internalToggle.checked = OPS_STATE.showInternal;
        internalToggle.addEventListener('change', () => {
          OPS_STATE.page = 1;
          loadOperations();
        });
      }
    }

    async function init(){
      showLoader(true);
      try {
        if (isAppsScript){
          const boot = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getBootstrap();
          });
          BOOT = boot;
          try {
            const platformInfo = await callServer('getPlatformInfo', navigator.userAgent);
            applyPlatformClass(platformInfo);
          } catch (platformErr) {
            if (boot && boot.settings && boot.settings.platform){
              applyPlatformClass(boot.settings.platform);
            }
          }
          OPS_DICTIONARIES.funds = Array.isArray(boot?.funds) ? boot.funds.slice() : [];
          OPS_DICTIONARIES.accounts = Array.isArray(boot?.accounts) ? boot.accounts.slice() : [];
          OPS_DICTIONARIES.categories = Array.isArray(boot?.categories) ? boot.categories.slice() : [];
          CURRENT.year = boot && boot.settings ? boot.settings.activeYear : CURRENT.year;

          const model = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getDashboard({ year: CURRENT.year, month: null });
          });

          const months = Array.isArray(model.months) ? model.months : [];
          fillMonths(CURRENT.year, months);
          CURRENT.month = months.length ? months[months.length - 1] : null;
          if (CURRENT.month){
            UI.month.value = CURRENT.month;
          }
          UI.month.addEventListener('change', (e) => {
            CURRENT.month = e.target.value;
            loadDashboard();
          });

          const rebuildBtn = document.getElementById('btn-rebuild');
          if (rebuildBtn){
            rebuildBtn.addEventListener('click', async () => {
              if (!CURRENT.year || !CURRENT.month) return;
              showLoader(true);
              try {
                const refreshed = await new Promise((resolve, reject) => {
                  google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .rebuildDashboard({ year: CURRENT.year, month: CURRENT.month });
                });
                renderDashboard(refreshed);
              } catch (err) {
                const message = String((err && err.message) || err || 'Помилка оновлення');
                if (window.uiModal && typeof window.uiModal.alert === 'function'){
                  await window.uiModal.alert(message, 'Помилка');
                } else if (typeof window.alert === 'function'){
                  window.alert(message);
                }
              } finally {
                showLoader(false);
              }
            });
          }

          UI.year.addEventListener('change',  (e) => {
            CURRENT.year = Number(e.target.value);
            loadDashboard();
          });

          const opsFunds = [];
          if (BOOT && Array.isArray(BOOT.funds)){
            opsFunds.push(...BOOT.funds);
          }
          if (Array.isArray(model?.items)){
            model.items.forEach(row => { if (row && row.fund) opsFunds.push(row.fund); });
          }
          populateOpsFunds(opsFunds);
          ensureOpsDefaultPeriod();

          renderDashboard(model);
        } else {
          const mock = buildMock();
          CURRENT.year = 2025;
          CURRENT.month = mock.monthKey;
          const ua = navigator.userAgent || '';
          const device = /android/i.test(ua) ? 'android' : (/iphone|ipad|ipod/i.test(ua) ? 'ios' : 'desktop');
          applyPlatformClass({ device, ua });
          fillMonths(CURRENT.year, [mock.monthKey]);
          UI.month.addEventListener('change', (e) => {
            CURRENT.month = e.target.value;
            loadDashboard();
          });
          const rebuildBtn = document.getElementById('btn-rebuild');
          if (rebuildBtn){
            rebuildBtn.addEventListener('click', () => {
              renderDashboard(buildMock());
            });
          }
          populateOpsFunds((mock.items || []).map(row => row.fund).filter(Boolean));
          OPS_DICTIONARIES.funds = (mock.items || []).map(row => row.fund).filter(Boolean);
          OPS_DICTIONARIES.accounts = [];
          OPS_DICTIONARIES.categories = [];
          ensureOpsDefaultPeriod();
          renderDashboard(mock);
        }
      } catch (err) {
        const message = String((err && err.message) || err || 'Помилка завантаження');
        if (window.uiModal && typeof window.uiModal.alert === 'function'){
          await window.uiModal.alert(message, 'Помилка');
        } else if (typeof window.alert === 'function'){
          window.alert(message);
        }
      } finally {
        showLoader(false);
      }
    }


    /* ===== Local mock (for preview without Apps Script) ===== */
    function buildMock(){
      const items = [
        {fund:'Пальне', plan: 6000, allocated: 5000, spent: 5200},
        {fund:'Продукти', plan: 12000, allocated: 10000, spent: 9800},
        {fund:'Комуналка', plan: 8000, allocated: 6000, spent: 7000},
        {fund:'Одяг', plan: 4000, allocated: 3000, spent: 1500},
        {fund:'Подарунки', plan: 5000, allocated: 3500, spent: 4200},
      ].map(x=> ({...x, gap: (x.allocated - x.spent), score: (x.spent / Math.max(x.allocated,1e-9))}));
      items.sort((a,b)=> b.score - a.score || a.gap - b.gap);
      const m = {
        plannedTotal: items.reduce((s,x)=>s+x.plan,0),
        allocatedTotal: items.reduce((s,x)=>s+x.allocated,0),
        spentTotal: items.reduce((s,x)=>s+x.spent,0)
      };
      return {
        monthKey: '2025-09',
        kpis: {
          plannedIncomesTotal: 0,
          plannedTotal: m.plannedTotal,
          allocatedTotal: m.allocatedTotal,
          spentTotal: m.spentTotal,
          mom: { incomes:null, planDist:null, allocated:null, spent:null },
          sparks: { planned:[8,9,7,10,11,12], allocated:[7,8,6,9,10,9], spent:[6,7,5,9,10,8] }
        },
        items,
        months: ['2025-09'],
        recent: [
          {date:'2025-09-18', fund:'Продукти', amount:-480, details:'АТБ'},
          {date:'2025-09-17', fund:'Пальне', amount:-1500, details:'OKKO'},
          {date:'2025-09-16', fund:'Комуналка', amount:-900, details:'Електроенергія'},
          {date:'2025-09-16', fund:'Подарунки', amount:-700, details:'LEGO'},
          {date:'2025-09-15', fund:'Одяг', amount:-650, details:'H&M'}
        ]
      };
    }

    setupTabs();
    setupOperationsUi();
    const initialHash = (location.hash || '').replace('#','');
    const initialTab = Object.keys(TABS).includes(initialHash) ? initialHash : 'dashboard';
    showTab(initialTab);
    init();
</script>
<script>
(function setupSplitActions(){
  const root = document.querySelector('.ops-table') || document;
  root.addEventListener('click', async (e)=>{
    const resolveBtn = e.target.closest('.btn-resolve-duplicate');
    if (resolveBtn){
      const itemId = resolveBtn.getAttribute('data-item-id') || '';
      await openDuplicateResolver(itemId);
      return;
    }
    const btn = e.target.closest('.btn-split'); if (!btn) return;
    const txId = btn.getAttribute('data-tx-id') || '';
    const bankId = btn.getAttribute('data-bank-id') || '';

    if (!txId && !bankId) {
      await uiModal.alert('Не знайдено ідентифікатор транзакції (itemId/bankId) для рознесення.', 'Помилка');
      return;
    }

    let payload;
    showOpsLoader();
    try {
      payload = await new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .txBuildSplitPayload({ txId: txId || null, bankId: bankId || null });
      });
    } catch (err) {
      await uiModal.alert(String((err && err.message) || err) || 'Помилка завантаження', 'Помилка');
      return;
    } finally {
      hideOpsLoader();
    }

    // Крок 1: повідомлення та підтвердження
    await uiModal.alert('Дані для рознесення завантажено.', 'Рознесення');
    const ok = await uiModal.confirm('Відкрити редактор рознесення для цієї операції?', 'Рознесення');
    if(!ok) return;

    // Крок 2: простий редактор частин
    const base = payload.mainAmount || 0;
    const formId = 'split-form-' + Date.now();
    const tpl = (rows)=>`
      <div id="${formId}">
        <p>Початкова сума: <b>${base}</b></p>
        <div id="split-rows" style="display:flex;flex-direction:column;gap:8px"></div>
        <button class="btn" id="add-part">+ Додати рядок</button>
      </div>`;
    const container = document.createElement('div');
    container.innerHTML = tpl(payload.items.filter(x=>x.isSplitPart));
    const host = container.querySelector('#split-rows');

    function addRow(part){
      const div=document.createElement('div');
      div.className='split-row';
      div.innerHTML=`
        <input class="input fund" placeholder="Фонд" value="${part?.fund||''}" style="width:26%">
        <input class="input amt" type="number" step="0.01" placeholder="Сума" value="${part?.amount||''}" style="width:18%">
        <input class="input det" placeholder="Деталі" value="${part?.details||''}" style="width:46%">
        <button class="btn btn--ghost rm" title="Видалити">&times;</button>`;
      host.appendChild(div);
      div.querySelector('.rm').onclick=()=>div.remove();
    }
    (payload.items||[]).filter(x=>x.isSplitPart).forEach(addRow);
    container.querySelector('#add-part').onclick=()=>addRow({});

    const confirmed = await uiModal.confirm(container.innerHTML, 'Рознесення');
    if(!confirmed) return;

    // Крок 3: збір та валідація
    const rows = Array.from(document.querySelectorAll('.split-row'));
    const parts = rows.map(r=>({
      fund: r.querySelector('.fund')?.value.trim(),
      amount: Number(r.querySelector('.amt')?.value),
      details: r.querySelector('.det')?.value.trim()
    }));
    const sum = parts.reduce((s,p)=>s+(Number(p.amount)||0),0);
    if (sum > base){ await uiModal.alert('Сума частин перевищує початкову. Виправте.', 'Помилка'); return; }

    // Крок 4: запис
    showOpsLoader();
    try {
      const res = await new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .txSaveSplitAllocation({
            bankId: payload.bankId, year: payload.year, mainItem: payload.mainItem, items: parts, indexMap: payload.indexMap
          });
      });
      if (res && res.ok){
        await uiModal.alert('Рознесення збережено', 'Готово');
        // перезавантажити поточну сторінку таблиці
        if (typeof loadOperations === 'function') loadOperations();
      }
    } catch (err) {
      const message = String((err && err.message) || err) || 'Сталася помилка';
      if (window.uiModal && typeof window.uiModal.alert === 'function'){
        await window.uiModal.alert(message, 'Помилка');
      } else if (typeof window.alert === 'function'){
        window.alert(message);
      }
    } finally {
      hideOpsLoader();
    }
  });
})();
</script>
<script>
// === uiModal: alert / confirm / prompt (cautious) =========================
window.uiModal = (function(){
  const root = () => document.getElementById('app-modal');
  const el = id => document.getElementById(id);
  let prevActive = null;

  function open({ title='', body='', okText='OK', cancelText='Скасувати', showCancel=false, trap=true, onOpen=null }) {
    const r = root(); if(!r) return;
    el('app-modal-title').textContent = title;
    el('app-modal-body').innerHTML = body;
    const okBtn = el('app-modal-ok'); okBtn.textContent = okText;
    const cancelBtn = el('app-modal-cancel'); cancelBtn.textContent = cancelText;
    cancelBtn.style.display = showCancel ? '' : 'none';

    if (typeof onOpen === 'function') {
      try {
        onOpen({ root: r, bodyEl: el('app-modal-body'), okBtn, cancelBtn });
      } catch (err) {
        console.error(err);
      }
    }

    return new Promise((resolve)=> {
      const close = (result) => {
        r.style.display = 'none'; document.body.classList.remove('modal-open');
        r.setAttribute('aria-hidden','true'); cleanup(); if(prevActive) prevActive.focus(); resolve(result);
      };
      function onKey(e){ if(e.key==='Escape'){ e.preventDefault(); close(null);} if(e.key==='Enter'&&document.activeElement===okBtn){ e.preventDefault(); close(true);} }
      function onBackdrop(e){ if(e.target.hasAttribute('data-modal-close')) close(null); }
      function cleanup(){ okBtn.removeEventListener('click', okH); cancelBtn.removeEventListener('click', cancelH); r.removeEventListener('keydown', onKey); r.removeEventListener('click', onBackdrop); }
      function okH(){ close(true); } function cancelH(){ close(null); }

      prevActive = document.activeElement; r.style.display='block'; document.body.classList.add('modal-open'); r.removeAttribute('aria-hidden');
      okBtn.addEventListener('click', okH); cancelBtn.addEventListener('click', cancelH);
      r.addEventListener('keydown', onKey); r.addEventListener('click', onBackdrop);
      if(trap) okBtn.focus();
    });
  }
  return {
    alert: async (msg, title='Повідомлення') => { await open({title, body: `<p>${msg}</p>`, showCancel:false}); },
    confirm: async (msg, title='Підтвердження') => !!(await open({title, body:`<p>${msg}</p>`, showCancel:true, okText:'Підтвердити'})),
    prompt: async (cfg) => {
      const { title='Введення', label='Значення', placeholder='', defaultValue='' } = (cfg||{});
      const id='modal-input-'+Date.now();
      const ok = await open({ title, showCancel:true, okText:'Зберегти', body:`<label style="display:block;margin-bottom:8px">${label}</label><input id="${id}" class="input" placeholder="${placeholder}" value="${defaultValue||''}" style="width:100%;padding:10px;border-radius:8px;border:1px solid #2a2a2a;background:#0f0f0f;color:#f3f3f3">` });
      if(!ok) return null;
      const v = document.getElementById(id).value; return v;
    },
    custom: async (cfg={}) => {
      const {
        title='Модальне вікно',
        body='',
        okText='Зберегти',
        cancelText='Скасувати',
        showCancel=true,
        trap=true,
        onOpen=null
      } = cfg || {};
      return open({ title, body, okText, cancelText, showCancel, trap, onOpen });
    }
  };
})();
// ========================================================================
</script>
</body>
</html>
